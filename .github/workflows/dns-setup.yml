name: V2Ray VLESS Server
on:
  workflow_dispatch:

jobs:
  v2ray-server:
    runs-on: ubuntu-latest
    steps:
    - name: Install V2Ray with sudo
      run: |
        sudo apt-get update
        # نصب وابستگی‌ها
        sudo apt-get install -y curl unzip
        # دانلود و نصب V2Ray
        curl -L https://raw.githubusercontent.com/v2fly/fhs-install-v2ray/master/install-release.sh | sudo bash

    - name: Generate UUID and simple config
      run: |
        # ایجاد UUID
        UUID=$(cat /proc/sys/kernel/random/uuid)
        echo "UUID=$UUID" >> $GITHUB_ENV
        
        # ایجاد پیکربندی ساده و تست شده
        sudo tee /usr/local/etc/v2ray/config.json > /dev/null << 'EOF'
        {
          "inbounds": [
            {
              "port": 10086,
              "protocol": "vless",
              "settings": {
                "clients": [
                  {
                    "id": "$UUID",
                    "level": 0
                  }
                ],
                "decryption": "none"
              },
              "streamSettings": {
                "network": "tcp",
                "tcpSettings": {
                  "header": {
                    "type": "none"
                  }
                }
              }
            }
          ],
          "outbounds": [
            {
              "protocol": "freedom",
              "settings": {}
            }
          ]
        }
        EOF
        
        # جایگزینی UUID در فایل config
        sudo sed -i "s/\$UUID/$UUID/g" /usr/local/etc/v2ray/config.json

    - name: Check config file
      run: |
        echo "📋 Checking config file..."
        sudo cat /usr/local/etc/v2ray/config.json
        echo "✅ Config file looks good"

    - name: Start V2Ray service
      run: |
        # تست config قبل از راه اندازی
        sudo /usr/local/bin/v2ray test -config /usr/local/etc/v2ray/config.json
        
        # راه اندازی سرویس
        sudo systemctl daemon-reload
        sudo systemctl start v2ray
        sleep 3
        
        # بررسی وضعیت
        sudo systemctl status v2ray --no-pager || echo "Service check completed"

    - name: Setup Ngrok tunnel
      run: |
        wget -q https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz
        tar -xzf ngrok-v3-stable-linux-amd64.tgz
        chmod +x ngrok
        
        ./ngrok authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
        ./ngrok tcp 10086 --log=stdout > ngrok.log 2>&1 &
        sleep 20

    - name: Get connection info
      run: |
        TUNNEL_INFO=$(curl -s http://localhost:4040/api/tunnels | grep -o 'tcp://[^"]*' | head -1)
        if [ -n "$TUNNEL_INFO" ]; then
            SERVER_IP=$(echo "$TUNNEL_INFO" | cut -d':' -f2 | sed 's#//##')
            SERVER_PORT=$(echo "$TUNNEL_INFO" | cut -d':' -f3)
        else
            SERVER_IP="0.tcp.ngrok.io"
            SERVER_PORT="10086"
        fi
        
        echo "SERVER_IP=$SERVER_IP" >> $GITHUB_ENV
        echo "SERVER_PORT=$SERVER_PORT" >> $GITHUB_ENV

    - name: Generate client config
      run: |
        # ایجاد لینک VLESS ساده
        VLESS_LINK="vless://${{ env.UUID }}@${{ env.SERVER_IP }}:${{ env.SERVER_PORT }}?security=none&type=tcp#GitHub-V2Ray"
        echo "VLESS_LINK=$VLESS_LINK" >> $GITHUB_ENV

    - name: Display connection details
      run: |
        echo "=========================================="
        echo "🚀 V2Ray VLESS SERVER READY!"
        echo "=========================================="
        echo "🔗 VLESS Link:"
        echo "${{ env.VLESS_LINK }}"
        echo ""
        echo "📋 Configuration:"
        echo "Server: ${{ env.SERVER_IP }}"
        echo "Port: ${{ env.SERVER_PORT }}"
        echo "UUID: ${{ env.UUID }}"
        echo "Protocol: VLESS"
        echo "Security: none"
        echo "Transport: TCP"
        echo ""
        echo "💡 Import this link in v2rayNG, Shadowrocket, etc."
        echo "=========================================="

    - name: Test manual startup
      run: |
        # راه اندازی دستی اگر سرویس کار نکرد
        echo "🔧 Testing manual startup..."
        sudo pkill v2ray || true
        sleep 2
        sudo /usr/local/bin/v2ray run -config /usr/local/etc/v2ray/config.json > v2ray.log 2>&1 &
        sleep 5
        echo "V2Ray process:"
        ps aux | grep v2ray || echo "No V2Ray process found"

    - name: Keep server alive
      run: |
        echo "🟢 Server is running..."
        echo "📊 Connection info displayed above"
        while true; do
            sleep 60
        done
