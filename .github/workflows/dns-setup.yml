name: Personal DNS Server
on:
  workflow_dispatch:

jobs:
  dns-server:
    runs-on: ubuntu-latest
    steps:
    - name: Install dnsmasq
      run: |
        sudo apt-get update
        sudo apt-get install -y dnsmasq
        echo "âœ… dnsmasq installed"

    - name: Setup dnsmasq configuration
      run: |
        # Ø§ÛŒØ¬Ø§Ø¯ Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ Ø³Ø§Ø¯Ù‡
        sudo tee /etc/dnsmasq.conf > /dev/null << EOF
        interface=lo
        listen-address=127.0.0.1
        server=8.8.8.8
        server=1.1.1.1
        address=/steam.com/104.112.119.210
        address=/epicgames.com/104.16.109.18
        address=/origin.com/104.112.119.210
        address=/battle.net/104.16.109.18
        no-hosts
        no-resolv
        EOF

        # Ø±Ø§Ù‡ Ø§Ù†Ø¯Ø§Ø²ÛŒ dnsmasq
        sudo systemctl restart dnsmasq
        sleep 2
        nslookup steam.com 127.0.0.1 && echo "âœ… DNS working"

    - name: Download Ngrok (RDP Proven Method)
      run: |
        # Ø±ÙˆØ´ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† (Ù…Ø«Ù„ RDP)
        curl -o ngrok.tgz https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz || \
        wget -O ngrok.tgz https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz
        
        tar -xzf ngrok.tgz
        chmod +x ngrok
        ./ngrok version && echo "âœ… Ngrok downloaded"

    - name: Setup Ngrok Authentication
      run: |
        # ØªÙ†Ø¸ÛŒÙ… authtoken (Ù…Ø«Ù„ RDP)
        ./ngrok authtoken "${{ secrets.NGROK_AUTH_TOKEN }}"
        echo "âœ… Ngrok authenticated"

    - name: Start Ngrok Tunnel (RDP Style)
      run: |
        # Ø±ÙˆØ´ Ø±Ø§Ù‡ Ø§Ù†Ø¯Ø§Ø²ÛŒ ØªÙˆÙ†Ù„ Ù…Ø«Ù„ RDP
        echo "ðŸŒ Starting Ngrok tunnel for DNS..."
        
        # Ø§Ø¬Ø±Ø§ÛŒ ngrok Ø¯Ø± Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡ (Ù…Ø«Ù„ RDP)
        nohup ./ngrok tcp 53 --log=stdout > ngrok.log 2>&1 &
        
        # Ù…Ù†ØªØ¸Ø± Ù…Ø§Ù†Ø¯Ù† Ø¨Ø±Ø§ÛŒ Ø±Ø§Ù‡ Ø§Ù†Ø¯Ø§Ø²ÛŒ
        sleep 25
        
        # Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª ngrok
        if ps aux | grep -q "[n]grok"; then
            echo "âœ… Ngrok tunnel is running"
            
            # Ø¯Ø±ÛŒØ§ÙØª Ø¢Ø¯Ø±Ø³ Ø§Ø² log (Ù…Ø«Ù„ RDP)
            TUNNEL_URL=$(grep "started tunnel" ngrok.log | grep -o "url=tcp://[^ ]*" | cut -d'=' -f2 || echo "")
            
            if [ -n "$TUNNEL_URL" ]; then
                DNS_IP=$(echo "$TUNNEL_URL" | cut -d':' -f2 | sed 's#//##')
                DNS_PORT=$(echo "$TUNNEL_URL" | cut -d':' -f3)
                echo "ðŸŒ Tunnel URL: $TUNNEL_URL"
                echo "ðŸ”¢ IP: $DNS_IP"
                echo "ðŸ”Œ Port: $DNS_PORT"
            else
                # Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø±ÙˆØ´ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†
                DNS_IP="0.tcp.ngrok.io"
                DNS_PORT="53"
                echo "â„¹ï¸ Using default ngrok address"
            fi
        else
            echo "âŒ Ngrok failed to start"
            cat ngrok.log || echo "No log file"
            DNS_IP="0.tcp.ngrok.io"
            DNS_PORT="53"
        fi
        
        echo "DNS_IP=$DNS_IP" >> $GITHUB_ENV
        echo "DNS_PORT=$DNS_PORT" >> $GITHUB_ENV

    - name: Display Connection Information
      run: |
        echo "=========================================="
        echo "ðŸŽ¯ DNS SERVER READY - USE IN DNS CHANGER APP"
        echo "=========================================="
        echo "Primary DNS: ${{ env.DNS_IP }}"
        echo "Port: ${{ env.DNS_PORT }}"
        echo ""
        echo "ðŸ“± Ø¯Ø± Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† DNS Changer:"
        echo "Address: ${{ env.DNS_IP }}"
        echo "Port: ${{ env.DNS_PORT }}"
        echo ""
        echo "ðŸ”§ Test: nslookup steam.com ${{ env.DNS_IP }}"
        echo "=========================================="

    - name: Keep Alive (Like RDP)
      run: |
        # Ø±ÙˆØ´ Ù†Ú¯Ù‡Ø¯Ø§Ø±ÛŒ Ù…Ø§Ù†Ù†Ø¯ RDP
        echo "ðŸŸ¢ DNS Server is running..."
        echo "ðŸ’¡ Press 'Cancel workflow' to stop"
        echo ""
        
        while true; do
            # ØªØ³Øª Ø³Ù„Ø§Ù…Øª
            if nslookup steam.com 127.0.0.1 >/dev/null 2>&1; then
                echo "âœ… DNS: OK - $(date +'%H:%M:%S')"
            else
                echo "âŒ DNS: Restarting..."
                sudo systemctl restart dnsmasq
            fi
            
            # Ø¨Ø±Ø±Ø³ÛŒ ngrok
            if ! ps aux | grep -q "[n]grok"; then
                echo "ðŸ”„ Restarting ngrok..."
                pkill ngrok || true
                nohup ./ngrok tcp 53 --log=stdout > ngrok.log 2>&1 &
                sleep 15
            fi
            
            sleep 30
        done
