name: V2Ray VLESS Server
on:
  workflow_dispatch:

jobs:
  v2ray-server:
    runs-on: ubuntu-latest
    steps:
    - name: Install V2Ray with sudo
      run: |
        sudo apt-get update
        # Ù†ØµØ¨ ÙˆØ§Ø¨Ø³ØªÚ¯ÛŒâ€ŒÙ‡Ø§
        sudo apt-get install -y curl unzip
        # Ø¯Ø§Ù†Ù„ÙˆØ¯ Ùˆ Ù†ØµØ¨ V2Ray
        curl -L https://raw.githubusercontent.com/v2fly/fhs-install-v2ray/master/install-release.sh | sudo bash

    - name: Generate UUID and simple config
      run: |
        # Ø§ÛŒØ¬Ø§Ø¯ UUID
        UUID=$(cat /proc/sys/kernel/random/uuid)
        echo "UUID=$UUID" >> $GITHUB_ENV
        
        # Ø§ÛŒØ¬Ø§Ø¯ Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ Ø³Ø§Ø¯Ù‡ Ùˆ ØªØ³Øª Ø´Ø¯Ù‡
        sudo tee /usr/local/etc/v2ray/config.json > /dev/null << 'EOF'
        {
          "inbounds": [
            {
              "port": 10086,
              "protocol": "vless",
              "settings": {
                "clients": [
                  {
                    "id": "$UUID",
                    "level": 0
                  }
                ],
                "decryption": "none"
              },
              "streamSettings": {
                "network": "tcp",
                "tcpSettings": {
                  "header": {
                    "type": "none"
                  }
                }
              }
            }
          ],
          "outbounds": [
            {
              "protocol": "freedom",
              "settings": {}
            }
          ]
        }
        EOF
        
        # Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†ÛŒ UUID Ø¯Ø± ÙØ§ÛŒÙ„ config
        sudo sed -i "s/\$UUID/$UUID/g" /usr/local/etc/v2ray/config.json

    - name: Check config file
      run: |
        echo "ðŸ“‹ Checking config file..."
        sudo cat /usr/local/etc/v2ray/config.json
        echo "âœ… Config file looks good"

    - name: Start V2Ray service
      run: |
        # ØªØ³Øª config Ù‚Ø¨Ù„ Ø§Ø² Ø±Ø§Ù‡ Ø§Ù†Ø¯Ø§Ø²ÛŒ
        sudo /usr/local/bin/v2ray test -config /usr/local/etc/v2ray/config.json
        
        # Ø±Ø§Ù‡ Ø§Ù†Ø¯Ø§Ø²ÛŒ Ø³Ø±ÙˆÛŒØ³
        sudo systemctl daemon-reload
        sudo systemctl start v2ray
        sleep 3
        
        # Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª
        sudo systemctl status v2ray --no-pager || echo "Service check completed"

    - name: Setup Ngrok tunnel
      run: |
        wget -q https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz
        tar -xzf ngrok-v3-stable-linux-amd64.tgz
        chmod +x ngrok
        
        ./ngrok authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
        ./ngrok tcp 10086 --log=stdout > ngrok.log 2>&1 &
        sleep 20

    - name: Get connection info
      run: |
        TUNNEL_INFO=$(curl -s http://localhost:4040/api/tunnels | grep -o 'tcp://[^"]*' | head -1)
        if [ -n "$TUNNEL_INFO" ]; then
            SERVER_IP=$(echo "$TUNNEL_INFO" | cut -d':' -f2 | sed 's#//##')
            SERVER_PORT=$(echo "$TUNNEL_INFO" | cut -d':' -f3)
        else
            SERVER_IP="0.tcp.ngrok.io"
            SERVER_PORT="10086"
        fi
        
        echo "SERVER_IP=$SERVER_IP" >> $GITHUB_ENV
        echo "SERVER_PORT=$SERVER_PORT" >> $GITHUB_ENV

    - name: Generate client config
      run: |
        # Ø§ÛŒØ¬Ø§Ø¯ Ù„ÛŒÙ†Ú© VLESS Ø³Ø§Ø¯Ù‡
        VLESS_LINK="vless://${{ env.UUID }}@${{ env.SERVER_IP }}:${{ env.SERVER_PORT }}?security=none&type=tcp#GitHub-V2Ray"
        echo "VLESS_LINK=$VLESS_LINK" >> $GITHUB_ENV

    - name: Display connection details
      run: |
        echo "=========================================="
        echo "ðŸš€ V2Ray VLESS SERVER READY!"
        echo "=========================================="
        echo "ðŸ”— VLESS Link:"
        echo "${{ env.VLESS_LINK }}"
        echo ""
        echo "ðŸ“‹ Configuration:"
        echo "Server: ${{ env.SERVER_IP }}"
        echo "Port: ${{ env.SERVER_PORT }}"
        echo "UUID: ${{ env.UUID }}"
        echo "Protocol: VLESS"
        echo "Security: none"
        echo "Transport: TCP"
        echo ""
        echo "ðŸ’¡ Import this link in v2rayNG, Shadowrocket, etc."
        echo "=========================================="

    - name: Test manual startup
      run: |
        # Ø±Ø§Ù‡ Ø§Ù†Ø¯Ø§Ø²ÛŒ Ø¯Ø³ØªÛŒ Ø§Ú¯Ø± Ø³Ø±ÙˆÛŒØ³ Ú©Ø§Ø± Ù†Ú©Ø±Ø¯
        echo "ðŸ”§ Testing manual startup..."
        sudo pkill v2ray || true
        sleep 2
        sudo /usr/local/bin/v2ray run -config /usr/local/etc/v2ray/config.json > v2ray.log 2>&1 &
        sleep 5
        echo "V2Ray process:"
        ps aux | grep v2ray || echo "No V2Ray process found"

    - name: Keep server alive
      run: |
        echo "ðŸŸ¢ Server is running..."
        echo "ðŸ“Š Connection info displayed above"
        while true; do
            sleep 60
        done
