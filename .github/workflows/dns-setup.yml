name: Personal DNS Server for Mobile Legends
on:
  workflow_dispatch:

jobs:
  dns-server:
    runs-on: ubuntu-latest
    steps:
    - name: Install dnsmasq
      run: |
        sudo apt-get update
        sudo apt-get install -y dnsmasq
        echo "âœ… dnsmasq installed"

    - name: Stop systemd services and free port 53
      run: |
        # ØªÙˆÙ‚Ù Ú©Ø§Ù…Ù„ Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§ÛŒ ØªØ¯Ø§Ø®Ù„â€ŒÚ©Ù†Ù†Ø¯Ù‡
        sudo systemctl stop systemd-resolved 2>/dev/null || true
        sudo systemctl disable systemd-resolved 2>/dev/null || true
        sudo systemctl stop dnsmasq 2>/dev/null || true
        
        # Ø¢Ø²Ø§Ø¯ Ú©Ø±Ø¯Ù† Ù¾ÙˆØ±Øª 53
        sudo pkill -f dnsmasq 2>/dev/null || true
        sudo pkill -f systemd-resolve 2>/dev/null || true
        sudo fuser -k 53/udp 2>/dev/null || true
        sudo fuser -k 53/tcp 2>/dev/null || true
        sleep 3

    - name: Create dnsmasq config for Mobile Legends
      run: |
        # Ø§ÛŒØ¬Ø§Ø¯ Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ Ù…Ø®ØµÙˆØµ Ø¨Ø§Ø²ÛŒâ€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ¨Ø§ÛŒÙ„
        cat > mobile_dns.conf << 'EOF'
interface=lo
listen-address=127.0.0.1
port=5353  # Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ù¾ÙˆØ±Øª ØºÛŒØ± Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² ØªØ¯Ø§Ø®Ù„
server=8.8.8.8
server=1.1.1.1
# DNS Ù‡Ø§ÛŒ Ù…Ø®ØµÙˆØµ Ø¨Ø§Ø²ÛŒâ€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ¨Ø§ÛŒÙ„
address=/mlbb.com/104.16.121.233
address=/mobilelegends.com/104.18.122.45
address=/moonton.com/104.18.123.456
address=/google.com/8.8.8.8
address=/apple.com/17.253.144.10
no-hosts
no-resolv
bind-interfaces
cache-size=1000
EOF

    - name: Run dnsmasq manually (no systemd)
      run: |
        # Ø§Ø¬Ø±Ø§ÛŒ Ø¯Ø³ØªÛŒ dnsmasq Ø±ÙˆÛŒ Ù¾ÙˆØ±Øª 5353
        sudo pkill -f dnsmasq 2>/dev/null || true
        sleep 2
        
        # Ø§Ø¬Ø±Ø§ Ø¯Ø± Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡ Ø±ÙˆÛŒ Ù¾ÙˆØ±Øª 5353
        sudo dnsmasq -C mobile_dns.conf --no-daemon &
        sleep 3
        
        # ØªØ³Øª DNS
        echo "Testing Mobile Legends DNS..."
        nslookup mlbb.com 127.0.0.1 -port=5353 && echo "âœ… Mobile Legends DNS working!"
        nslookup google.com 127.0.0.1 -port=5353 && echo "âœ… General DNS working!"

    - name: Download and setup Ngrok
      run: |
        # Ø¯Ø§Ù†Ù„ÙˆØ¯ ngrok
        wget -q https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz
        tar -xzf ngrok-v3-stable-linux-amd64.tgz
        chmod +x ngrok
        
        # ØªÙ†Ø¸ÛŒÙ… auth token
        ./ngrok authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
        
        # Ø±Ø§Ù‡ Ø§Ù†Ø¯Ø§Ø²ÛŒ ØªÙˆÙ†Ù„ Ø¨Ø±Ø§ÛŒ Ù¾ÙˆØ±Øª 5353 (Ù†Ù‡ 53)
        ./ngrok tcp 5353 --log=stdout > ngrok.log 2>&1 &
        echo "ğŸ”„ Starting ngrok tunnel for port 5353..."
        sleep 25

    - name: Get connection information
      run: |
        # Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØªÙˆÙ†Ù„
        echo "Getting tunnel information..."
        
        # Ø±ÙˆØ´ Ù…Ø·Ù…Ø¦Ù† Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ø¢Ø¯Ø±Ø³
        TUNNEL_URL=$(curl -s http://localhost:4040/api/tunnels 2>/dev/null | grep -o 'tcp://[^"]*' | head -1 || echo "")
        
        if [ -n "$TUNNEL_URL" ]; then
            DNS_IP=$(echo "$TUNNEL_URL" | cut -d':' -f2 | sed 's#//##')
            DNS_PORT=$(echo "$TUNNEL_URL" | cut -d':' -f3)
        else
            # Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø¢Ø¯Ø±Ø³ Ù¾ÛŒØ´â€ŒÙØ±Ø¶
            DNS_IP="0.tcp.ngrok.io"
            DNS_PORT=$(grep -o "url=tcp://[^ ]*" ngrok.log | head -1 | cut -d':' -f3 | cut -d' ' -f1 || echo "5353")
        fi
        
        echo "DNS_IP=$DNS_IP" >> $GITHUB_ENV
        echo "DNS_PORT=$DNS_PORT" >> $GITHUB_ENV

    - name: Display Mobile Legends DNS Info
      run: |
        echo "=========================================="
        echo "ğŸ¯ MOBILE LEGENDS DNS SERVER READY!"
        echo "=========================================="
        echo "ğŸ“± Ø¨Ø±Ø§ÛŒ DNS Changer Ú¯ÙˆØ´ÛŒ:"
        echo "Primary DNS: ${{ env.DNS_IP }}"
        echo "Port: ${{ env.DNS_PORT }}"
        echo ""
        echo "ğŸ”§ ØªØ³Øª Ø§ØªØµØ§Ù„:"
        echo "nslookup mlbb.com ${{ env.DNS_IP }} -port=${{ env.DNS_PORT }}"
        echo ""
        echo "âœ¨ Ù…Ø®ØµÙˆØµ Ø¨Ø§Ø²ÛŒ Mobile Legends"
        echo "=========================================="

    - name: Keep alive for mobile gaming
      run: |
        echo "ğŸŸ¢ Mobile Legends DNS Server is running..."
        echo "ğŸ“± Ø¨Ø±Ø§ÛŒ Ù‚Ø·Ø¹ Ú©Ø±Ø¯Ù†: Cancel workflow Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯"
        echo ""
        
        COUNTER=0
        while true; do
            COUNTER=$((COUNTER + 1))
            echo "â° ÙØ¹Ø§Ù„ Ø¨Ù‡ Ù…Ø¯Øª $((COUNTER * 30)) Ø«Ø§Ù†ÛŒÙ‡..."
            
            # ØªØ³Øª Ø³Ù„Ø§Ù…Øª
            if nslookup mlbb.com 127.0.0.1 -port=5353 >/dev/null 2>&1; then
                echo "âœ… DNS Mobile Legends: ÙØ¹Ø§Ù„"
            else
                echo "ğŸ”„ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ù…Ø¬Ø¯Ø¯ DNS..."
                sudo pkill -f dnsmasq
                sudo dnsmasq -C mobile_dns.conf --no-daemon &
            fi
            
            sleep 30
        done
