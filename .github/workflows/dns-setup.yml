name: Personal DNS Server with Static IP
on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'

jobs:
  dns-server:
    runs-on: ubuntu-latest
    steps:
    - name: Setup DNS Server
      run: |
        sudo apt-get update
        sudo apt-get install -y dnsmasq

        echo "listen-address=0.0.0.0" | sudo tee /etc/dnsmasq.conf
        echo "server=8.8.8.8" | sudo tee -a /etc/dnsmasq.conf
        echo "server=1.1.1.1" | sudo tee -a /etc/dnsmasq.conf
        echo "address=/steam.com/104.112.119.210" | sudo tee -a /etc/dnsmasq.conf
        echo "address=/epicgames.com/104.16.109.18" | sudo tee -a /etc/dnsmasq.conf
        
        sudo systemctl restart dnsmasq
        echo "âœ… DNS Server configured!"

    - name: Setup Ngrok and Get IP Address
      run: |
        wget https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz
        tar -xzf ngrok-v3-stable-linux-amd64.tgz
        chmod +x ngrok
        
        ./ngrok authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
        
        # Ø±Ø§Ù‡ Ø§Ù†Ø¯Ø§Ø²ÛŒ ØªÙˆÙ†Ù„ Ùˆ Ø¯Ø±ÛŒØ§ÙØª IP
        ./ngrok tcp 53 --log=stdout > ngrok.log &
        sleep 15
        
        # Ø¯Ø±ÛŒØ§ÙØª IP Ø¹Ø¯Ø¯ÛŒ Ø§Ø² Ngrok
        NGROK_IP=$(curl -s http://localhost:4040/api/tunnels | jq -r '.tunnels[0].public_url' | cut -d':' -f2 | sed 's#//##')
        
        # ØªØ¨Ø¯ÛŒÙ„ Ø¯Ø§Ù…Ù†Ù‡ Ø¨Ù‡ IP Ø¹Ø¯Ø¯ÛŒ (Ø§Ú¯Ø± Ù„Ø§Ø²Ù… Ø¨Ø§Ø´Ø¯)
        if [[ $NGROK_IP =~ [a-zA-Z] ]]; then
            NGROK_IP=$(dig +short $NGROK_IP | head -1)
        fi
        
        echo "ğŸŒ Numerical IP Address: $NGROK_IP"
        echo "DNS_IP=$NGROK_IP" >> $GITHUB_ENV

    - name: Display Connection Info
      run: |
        echo "=========================================="
        echo "âœ… DNS SERVER IS READY!"
        echo "=========================================="
        echo "ğŸ”¢ Numerical IP: ${{ env.DNS_IP }}"
        echo "ğŸ”Œ Port: 53"
        echo "=========================================="
        echo "ğŸ“± Ø¯Ø± Ú¯ÙˆØ´ÛŒ Ø®ÙˆØ¯ Ø§ÛŒÙ† Ø¢Ø¯Ø±Ø³ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:"
        echo "DNS 1: ${{ env.DNS_IP }}"
        echo "=========================================="

    - name: Keep alive
      run: |
        while true; do
            echo "ğŸŸ¢ DNS Server running at: ${{ env.DNS_IP }}:53"
            echo "â° Last update: $(date +'%Y-%m-%d %H:%M:%S')"
            sleep 60
        done
