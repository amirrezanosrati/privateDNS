name: Mobile Legends DNS Server
on:
  workflow_dispatch:

jobs:
  dns-server:
    runs-on: ubuntu-latest
    steps:
    - name: Install required packages
      run: |
        sudo apt-get update
        sudo apt-get install -y dnsmasq dnsutils

    - name: Setup dnsmasq configuration
      run: |
        # Ø§ÛŒØ¬Ø§Ø¯ Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ Ø³Ø§Ø¯Ù‡ Ø¨Ø§ Ø¢Ø¯Ø±Ø³â€ŒÙ‡Ø§ÛŒ Ù…Ø¹ØªØ¨Ø±
        sudo tee /etc/dnsmasq.conf > /dev/null << EOF
        port=5353
        listen-address=127.0.0.1
        server=8.8.8.8
        server=1.1.1.1
        address=/mlbb.com/104.16.121.233
        address=/mobilelegends.com/104.18.122.45
        # Ø­Ø°Ù Ø¢Ø¯Ø±Ø³ Ù†Ø§Ù…Ø¹ØªØ¨Ø± moonton.com
        no-hosts
        no-resolv
        EOF

    - name: Run dnsmasq manually
      run: |
        # ØªÙˆÙ‚Ù Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ
        sudo pkill dnsmasq || true
        sleep 2
        
        # Ø§Ø¬Ø±Ø§ÛŒ dnsmasq Ø±ÙˆÛŒ Ù¾ÙˆØ±Øª 5353
        sudo dnsmasq --port=5353 --no-daemon &
        sleep 3
        
        # ØªØ³Øª DNS Ø¨Ø§ dig
        echo "Testing DNS server..."
        dig @127.0.0.1 -p 5353 mlbb.com +short && echo "âœ… DNS server is working"

    - name: Download Ngrok
      run: |
        # Ø¯Ø§Ù†Ù„ÙˆØ¯ ngrok
        curl -s https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz -o ngrok.tgz
        tar -xzf ngrok.tgz
        chmod +x ngrok

    - name: Setup Ngrok authentication
      run: |
        ./ngrok authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
        echo "âœ… Ngrok authenticated"

    - name: Start Ngrok tunnel
      run: |
        # Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ ØªÙˆÙ†Ù„
        ./ngrok tcp 5353 --log=stdout > ngrok.log 2>&1 &
        sleep 20
        
        # Ø¯Ø±ÛŒØ§ÙØª Ø¢Ø¯Ø±Ø³ ØªÙˆÙ†Ù„
        TUNNEL_URL=$(curl -s http://localhost:4040/api/tunnels | grep -o "tcp://[^\"]*" | head -1 || echo "")
        if [ -n "$TUNNEL_URL" ]; then
            echo "ğŸŒ Tunnel URL: $TUNNEL_URL"
            DNS_IP=$(echo "$TUNNEL_URL" | cut -d':' -f2 | sed 's#//##')
            DNS_PORT=$(echo "$TUNNEL_URL" | cut -d':' -f3)
        else
            # Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø¢Ø¯Ø±Ø³ Ù¾ÛŒØ´â€ŒÙØ±Ø¶
            DNS_IP="0.tcp.ngrok.io"
            DNS_PORT="5353"
            echo "âš ï¸ Using default ngrok address"
        fi
        
        echo "DNS_IP=$DNS_IP" >> $GITHUB_ENV
        echo "DNS_PORT=$DNS_PORT" >> $GITHUB_ENV

    - name: Display connection information
      run: |
        echo "========================================"
        echo "ğŸ¯ MOBILE LEGENDS DNS SERVER READY!"
        echo "========================================"
        echo "ğŸ“± DNS IP: ${{ env.DNS_IP }}"
        echo "ğŸ”Œ DNS Port: ${{ env.DNS_PORT }}"
        echo ""
        echo "ğŸ’¡ Ø¯Ø± DNS Changer Ú¯ÙˆØ´ÛŒ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:"
        echo "Address: ${{ env.DNS_IP }}"
        echo "Port: ${{ env.DNS_PORT }}"
        echo "========================================"

    - name: Keep workflow running
      run: |
        echo "ğŸŸ¢ Server is running..."
        echo "â° Press 'Cancel workflow' to stop"
        
        # Ø­Ù„Ù‚Ù‡ Ø¨ÛŒâ€ŒÙ†Ù‡Ø§ÛŒØª Ø³Ø§Ø¯Ù‡
        while true; do
            echo "âœ… Still running at $(date +'%H:%M:%S')"
            sleep 60
        done
