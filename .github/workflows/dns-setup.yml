name: V2Ray VLESS Server
on:
  workflow_dispatch:

jobs:
  v2ray-server:
    runs-on: ubuntu-latest
    steps:
    - name: Install V2Ray with sudo
      run: |
        sudo apt-get update
        # ŸÜÿµÿ® V2Ray ÿ®ÿß ÿØÿ≥ÿ™ÿ±ÿ≥€å sudo
        curl -L https://raw.githubusercontent.com/v2fly/fhs-install-v2ray/master/install-release.sh | sudo bash

    - name: Generate UUID and config
      run: |
        # ÿß€åÿ¨ÿßÿØ UUID
        UUID=$(cat /proc/sys/kernel/random/uuid)
        echo "UUID=$UUID" >> $GITHUB_ENV
        
        # ÿß€åÿ¨ÿßÿØ Ÿæ€å⁄©ÿ±ÿ®ŸÜÿØ€å V2Ray
        sudo tee /usr/local/etc/v2ray/config.json > /dev/null << EOF
        {
          "inbounds": [
            {
              "port": 443,
              "protocol": "vless",
              "settings": {
                "clients": [
                  {
                    "id": "$UUID",
                    "flow": "xtls-rprx-vision"
                  }
                ],
                "decryption": "none"
              },
              "streamSettings": {
                "network": "tcp",
                "security": "tls",
                "tlsSettings": {
                  "certificates": [
                    {
                      "certificateFile": "/usr/local/etc/v2ray/selfsigned.crt",
                      "keyFile": "/usr/local/etc/v2ray/selfsigned.key"
                    }
                  ]
                }
              }
            }
          ],
          "outbounds": [
            {
              "protocol": "freedom",
              "settings": {}
            }
          ]
        }
        EOF

    - name: Generate self-signed certificate
      run: |
        # ÿß€åÿ¨ÿßÿØ certificate
        sudo openssl req -x509 -nodes -newkey rsa:2048 \
          -keyout /usr/local/etc/v2ray/selfsigned.key \
          -out /usr/local/etc/v2ray/selfsigned.crt \
          -subj "/C=US/ST=State/L=City/O=Organization/CN=v2ray.com" \
          -days 3650
        
        sudo chmod 600 /usr/local/etc/v2ray/selfsigned.*

    - name: Start V2Ray service
      run: |
        sudo systemctl start v2ray
        sudo systemctl enable v2ray
        sleep 3
        sudo systemctl status v2ray --no-pager

    - name: Setup Ngrok tunnel
      run: |
        wget -q https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz
        tar -xzf ngrok-v3-stable-linux-amd64.tgz
        chmod +x ngrok
        
        ./ngrok authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
        ./ngrok tcp 443 --log=stdout > ngrok.log 2>&1 &
        sleep 20

    - name: Get connection info
      run: |
        TUNNEL_INFO=$(curl -s http://localhost:4040/api/tunnels | grep -o 'tcp://[^"]*' | head -1)
        if [ -n "$TUNNEL_INFO" ]; then
            SERVER_IP=$(echo "$TUNNEL_INFO" | cut -d':' -f2 | sed 's#//##')
            SERVER_PORT=$(echo "$TUNNEL_INFO" | cut -d':' -f3)
        else
            SERVER_IP="0.tcp.ngrok.io"
            SERVER_PORT="443"
        fi
        
        echo "SERVER_IP=$SERVER_IP" >> $GITHUB_ENV
        echo "SERVER_PORT=$SERVER_PORT" >> $GITHUB_ENV

    - name: Generate client config
      run: |
        # ÿß€åÿ¨ÿßÿØ ŸÑ€åŸÜ⁄© VLESS
        VLESS_LINK="vless://${{ env.UUID }}@${{ env.SERVER_IP }}:${{ env.SERVER_PORT }}?type=tcp&security=tls&flow=xtls-rprx-vision#GitHub-V2Ray"
        echo "VLESS_LINK=$VLESS_LINK" >> $GITHUB_ENV

    - name: Display connection details
      run: |
        echo "=========================================="
        echo "üöÄ V2Ray VLESS SERVER READY!"
        echo "=========================================="
        echo "üîó VLESS Link:"
        echo "${{ env.VLESS_LINK }}"
        echo ""
        echo "üìã Configuration:"
        echo "Server: ${{ env.SERVER_IP }}"
        echo "Port: ${{ env.SERVER_PORT }}"
        echo "UUID: ${{ env.UUID }}"
        echo "Protocol: VLESS"
        echo "Security: TLS"
        echo "Flow: xtls-rprx-vision"
        echo ""
        echo "üí° Import this link in v2rayNG, Shadowrocket, etc."
        echo "=========================================="

    - name: Keep server alive
      run: |
        echo "üü¢ V2Ray server running with optimal performance!"
        echo "‚è∞ Low ping with TLS and optimized settings"
        while true; do
            echo "‚úÖ Active - $(date +'%H:%M:%S')"
            sleep 60
        done
