name: Mobile Legends DNS with Numerical IP
on:
  workflow_dispatch:

jobs:
  dns-server:
    runs-on: ubuntu-latest
    steps:
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y dnsmasq dnsutils

    - name: Setup dnsmasq
      run: |
        sudo tee /etc/dnsmasq.conf > /dev/null << EOF
        port=5353
        listen-address=127.0.0.1
        server=8.8.8.8
        server=1.1.1.1
        address=/mlbb.com/104.16.121.233
        address=/mobilelegends.com/104.18.122.45
        no-hosts
        no-resolv
        EOF

    - name: Start dnsmasq
      run: |
        sudo pkill dnsmasq || true
        sleep 2
        sudo dnsmasq --port=5353 --no-daemon &
        sleep 3

    - name: Get Numerical IP from Ngrok
      run: |
        # Ø¯Ø§Ù†Ù„ÙˆØ¯ ngrok
        wget -q https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz
        tar -xzf ngrok-v3-stable-linux-amd64.tgz
        chmod +x ngrok
        
        ./ngrok authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
        
        # Ø±Ø§Ù‡ Ø§Ù†Ø¯Ø§Ø²ÛŒ ØªÙˆÙ†Ù„
        ./ngrok tcp 5353 --log=stdout > ngrok.log 2>&1 &
        sleep 20
        
        # Ø¯Ø±ÛŒØ§ÙØª IP Ø¹Ø¯Ø¯ÛŒ Ø§Ø² Ø¯Ø§Ù…Ù†Ù‡ ngrok
        NGROK_DOMAIN=$(curl -s http://localhost:4040/api/tunnels | grep -o 'tcp://[^"]*' | head -1 | cut -d':' -f2 | sed 's#//##')
        
        if [ -n "$NGROK_DOMAIN" ]; then
            # ØªØ¨Ø¯ÛŒÙ„ Ø¯Ø§Ù…Ù†Ù‡ Ø¨Ù‡ IP Ø¹Ø¯Ø¯ÛŒ
            NUMERICAL_IP=$(dig +short $NGROK_DOMAIN | head -1)
            echo "ðŸŒ Numerical IP: $NUMERICAL_IP"
            echo "NUMERICAL_IP=$NUMERICAL_IP" >> $GITHUB_ENV
        else
            # Fallback Ø¨Ù‡ IP Ù‡Ø§ÛŒ Ø¹Ù…ÙˆÙ…ÛŒ
            echo "ðŸŒ Using Cloudflare DNS as fallback"
            echo "NUMERICAL_IP=1.1.1.1" >> $GITHUB_ENV
        fi

    - name: Display Numerical DNS Info
      run: |
        echo "========================================"
        echo "ðŸŽ¯ NUMERICAL DNS SERVER READY!"
        echo "========================================"
        echo "ðŸ“± DNS IP: ${{ env.NUMERICAL_IP }}"
        echo "ðŸ”Œ DNS Port: 5353"
        echo ""
        echo "ðŸ’¡ Ø¯Ø± Ú¯ÙˆØ´ÛŒ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:"
        echo "Primary DNS: ${{ env.NUMERICAL_IP }}"
        echo "Port: 5353"
        echo "========================================"

    - name: Keep alive
      run: |
        echo "ðŸŸ¢ Numerical DNS Server is running..."
        while true; do
            echo "âœ… IP: ${{ env.NUMERICAL_IP }} - Active at $(date +'%H:%M:%S')"
            sleep 60
        done
