name: Private DNS Server Setup
on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'  # Ø±ÙˆØ²Ø§Ù†Ù‡ Ø§Ø¬Ø±Ø§ Ø´ÙˆØ¯

jobs:
  setup-dns:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Install dnsmasq
      run: |
        sudo apt-get update
        sudo apt-get install -y dnsmasq

    - name: Configure private DNS
      run: |
        # Ø§ÛŒØ¬Ø§Ø¯ Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ DNS Ø´Ø®ØµÛŒ
        echo "listen-address=0.0.0.0" | sudo tee /etc/dnsmasq.conf
        echo "server=8.8.8.8" | sudo tee -a /etc/dnsmasq.conf
        echo "server=1.1.1.1" | sudo tee -a /etc/dnsmasq.conf
        echo "address=/steam.com/104.112.119.210" | sudo tee -a /etc/dnsmasq.conf
        echo "address=/epicgames.com/104.16.109.18" | sudo tee -a /etc/dnsmasq.conf
        
        sudo systemctl restart dnsmasq
        echo "âœ… DNS Server configured successfully!"

    - name: Download and setup Ngrok
      run: |
        wget https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz
        tar -xzf ngrok-v3-stable-linux-amd64.tgz
        chmod +x ngrok
        
        # ØªÙ†Ø¸ÛŒÙ… ØªÙˆÚ©Ù† Ngrok
        ./ngrok authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
        
    - name: Start DNS tunnel
      run: |
        # Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ ØªÙˆÙ†Ù„ Ø¨Ø±Ø§ÛŒ DNS
        ./ngrok tcp 53 --log=stdout > ngrok.log &
        sleep 10  # Ù…Ù†ØªØ¸Ø± Ø¨Ù…Ø§Ù† ØªØ§ ØªÙˆÙ†Ù„ Ø±Ø§Ù‡ Ø¨ÛŒØ§ÛŒØ¯
        
        # Ø¯Ø±ÛŒØ§ÙØª Ø¢Ø¯Ø±Ø³ ØªÙˆÙ†Ù„
        TUNNEL_URL=$(curl -s http://localhost:4040/api/tunnels | jq -r '.tunnels[0].public_url')
        echo "ğŸ›¡ï¸ DNS Tunnel Established!"
        echo "ğŸ“ Tunnel URL: $TUNNEL_URL"
        
        # Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±
        echo "=========================================="
        echo "âœ… DNS SERVER IS READY!"
        echo "=========================================="
        echo "DNS Address: $(echo $TUNNEL_URL | cut -d':' -f2 | sed 's#//##')"
        echo "Port: $(echo $TUNNEL_URL | cut -d':' -f3)"
        echo "=========================================="
        
        # Ù†Ú¯Ù‡â€ŒØ¯Ø§Ø±ÛŒ Ø§Ø¬Ø±Ø§
        while true; do
            echo "ğŸŸ¢ DNS Server is running... (Ctrl+C to stop)"
            sleep 300
        done
