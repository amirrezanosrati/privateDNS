name: Personal DNS Server with Static IP
on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'

jobs:
  dns-server:
    runs-on: ubuntu-latest
    steps:
    - name: Setup DNS Server
      run: |
        sudo apt-get update
        sudo apt-get install -y dnsmasq

        echo "listen-address=0.0.0.0" | sudo tee /etc/dnsmasq.conf
        echo "server=8.8.8.8" | sudo tee -a /etc/dnsmasq.conf
        echo "server=1.1.1.1" | sudo tee -a /etc/dnsmasq.conf
        echo "address=/steam.com/104.112.119.210" | sudo tee -a /etc/dnsmasq.conf
        echo "address=/epicgames.com/104.16.109.18" | sudo tee -a /etc/dnsmasq.conf
        
        sudo systemctl restart dnsmasq
        echo "✅ DNS Server configured!"

    - name: Setup Ngrok and Get IP Address
      run: |
        wget https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz
        tar -xzf ngrok-v3-stable-linux-amd64.tgz
        chmod +x ngrok
        
        ./ngrok authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
        
        # راه اندازی تونل و دریافت IP
        ./ngrok tcp 53 --log=stdout > ngrok.log &
        sleep 15
        
        # دریافت IP عددی از Ngrok
        NGROK_IP=$(curl -s http://localhost:4040/api/tunnels | jq -r '.tunnels[0].public_url' | cut -d':' -f2 | sed 's#//##')
        
        # تبدیل دامنه به IP عددی (اگر لازم باشد)
        if [[ $NGROK_IP =~ [a-zA-Z] ]]; then
            NGROK_IP=$(dig +short $NGROK_IP | head -1)
        fi
        
        echo "🌐 Numerical IP Address: $NGROK_IP"
        echo "DNS_IP=$NGROK_IP" >> $GITHUB_ENV

    - name: Display Connection Info
      run: |
        echo "=========================================="
        echo "✅ DNS SERVER IS READY!"
        echo "=========================================="
        echo "🔢 Numerical IP: ${{ env.DNS_IP }}"
        echo "🔌 Port: 53"
        echo "=========================================="
        echo "📱 در گوشی خود این آدرس را وارد کنید:"
        echo "DNS 1: ${{ env.DNS_IP }}"
        echo "=========================================="

    - name: Keep alive
      run: |
        while true; do
            echo "🟢 DNS Server running at: ${{ env.DNS_IP }}:53"
            echo "⏰ Last update: $(date +'%Y-%m-%d %H:%M:%S')"
            sleep 60
        done
