name: Mobile Legends DNS Server
on:
  workflow_dispatch:

jobs:
  dns-server:
    runs-on: ubuntu-latest
    steps:
    - name: Install Python and required packages
      run: |
        sudo apt-get update
        sudo apt-get install -y python3 python3-pip
        pip3 install dnspython

    - name: Create Python DNS Server
      run: |
        cat > dns_server.py << 'EOF'
#!/usr/bin/env python3
import socketserver
import dns.resolver
import dns.message
import dns.rdataclass
import dns.rdatatype

# DNS mapping for Mobile Legends and games
DNS_MAPPING = {
    'mlbb.com': '104.16.121.233',
    'mobilelegends.com': '104.18.122.45', 
    'moonton.com': '104.18.123.456',
    'steam.com': '104.112.119.210',
    'epicgames.com': '104.16.109.18',
    'origin.com': '104.112.119.210',
    'battle.net': '104.16.109.18'
}

class DNSHandler(socketserver.BaseRequestHandler):
    def handle(self):
        data = self.request[0]
        socket = self.request[1]
        
        try:
            request = dns.message.from_wire(data)
            query_name = str(request.question[0].name).lower()
            
            response = dns.message.make_response(request)
            
            if query_name in DNS_MAPPING:
                # Ù¾Ø§Ø³Ø® Ø¨Ø§ IP Ø§Ø² mapping
                ip = DNS_MAPPING[query_name]
                rrset = dns.rrset.from_text(
                    request.question[0].name,
                    300,  # TTL
                    dns.rdataclass.IN,
                    dns.rdatatype.A,
                    ip
                )
                response.answer.append(rrset)
            else:
                # ÙÙˆØ±ÙˆØ§Ø±Ø¯ Ø¨Ù‡ DNS Ø¹Ù…ÙˆÙ…ÛŒ
                resolver = dns.resolver.Resolver()
                resolver.nameservers = ['8.8.8.8', '1.1.1.1']
                answer = resolver.resolve(query_name, 'A')
                for rdata in answer:
                    rrset = dns.rrset.from_text(
                        request.question[0].name,
                        300,
                        dns.rdataclass.IN, 
                        dns.rdatatype.A,
                        str(rdata)
                    )
                    response.answer.append(rrset)
            
            socket.sendto(response.to_wire(), self.client_address)
            print(f"âœ… DNS Query: {query_name}")
            
        except Exception as e:
            print(f"âŒ Error: {e}")

if __name__ == "__main__":
    print("ðŸš€ Starting Python DNS Server on port 5353...")
    print("ðŸ“± Mobile Legends DNS Ready!")
    server = socketserver.UDPServer(('0.0.0.0', 5353), DNSHandler)
    server.serve_forever()
EOF

        chmod +x dns_server.py
        echo "âœ… Python DNS Server created"

    - name: Start Python DNS Server
      run: |
        # Ø§Ø¬Ø±Ø§ÛŒ DNS Ø³Ø±ÙˆØ± Ø¯Ø± Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡
        nohup python3 dns_server.py > dns.log 2>&1 &
        echo $! > dns.pid
        sleep 5
        
        # ØªØ³Øª DNS Ø³Ø±ÙˆØ±
        echo "Testing DNS server..."
        nslookup mlbb.com 127.0.0.1 -port=5353 && echo "âœ… Mobile Legends DNS working!"
        nslookup google.com 127.0.0.1 -port=5353 && echo "âœ… General DNS working!"

    - name: Download and setup Ngrok
      run: |
        # Ø¯Ø§Ù†Ù„ÙˆØ¯ ngrok
        wget -q https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz
        tar -xzf ngrok-v3-stable-linux-amd64.tgz
        chmod +x ngrok
        
        # ØªÙ†Ø¸ÛŒÙ… auth token
        ./ngrok authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
        
        # Ø±Ø§Ù‡ Ø§Ù†Ø¯Ø§Ø²ÛŒ ØªÙˆÙ†Ù„ Ø¨Ø±Ø§ÛŒ Ù¾ÙˆØ±Øª 5353
        ./ngrok tcp 5353 --log=stdout > ngrok.log 2>&1 &
        echo $! > ngrok.pid
        echo "ðŸ”„ Starting ngrok tunnel..."
        sleep 25

    - name: Get connection information
      run: |
        # Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØªÙˆÙ†Ù„
        TUNNEL_INFO=$(curl -s http://localhost:4040/api/tunnels 2>/dev/null || echo "{}")
        TUNNEL_URL=$(echo "$TUNNEL_INFO" | grep -o 'tcp://[^"]*' | head -1 || echo "")
        
        if [ -n "$TUNNEL_URL" ]; then
            DNS_IP=$(echo "$TUNNEL_URL" | cut -d':' -f2 | sed 's#//##')
            DNS_PORT=$(echo "$TUNNEL_URL" | cut -d':' -f3)
        else
            DNS_IP="0.tcp.ngrok.io"
            DNS_PORT=$(grep -o "url=tcp://[^ ]*" ngrok.log | head -1 | cut -d':' -f3 | cut -d' ' -f1 || echo "5353")
        fi
        
        echo "DNS_IP=$DNS_IP" >> $GITHUB_ENV
        echo "DNS_PORT=$DNS_PORT" >> $GITHUB_ENV

    - name: Display connection info
      run: |
        echo "=========================================="
        echo "ðŸŽ¯ MOBILE LEGENDS DNS SERVER READY!"
        echo "=========================================="
        echo "ðŸ“± Ø¨Ø±Ø§ÛŒ DNS Changer Ú¯ÙˆØ´ÛŒ:"
        echo "Primary DNS: ${{ env.DNS_IP }}"
        echo "Port: ${{ env.DNS_PORT }}"
        echo ""
        echo "ðŸ”§ ØªØ³Øª Ø§ØªØµØ§Ù„:"
        echo "nslookup mlbb.com ${{ env.DNS_IP }} -port=${{ env.DNS_PORT }}"
        echo ""
        echo "âœ¨ Ù…Ø®ØµÙˆØµ Ø¨Ø§Ø²ÛŒ Mobile Legends"
        echo "=========================================="

    - name: Keep alive
      run: |
        echo "ðŸŸ¢ DNS Server is running..."
        echo "ðŸ’¡ Ø¨Ø±Ø§ÛŒ Ù‚Ø·Ø¹ Ú©Ø±Ø¯Ù†: Cancel workflow Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯"
        echo ""
        
        # Ø§Ø¬Ø±Ø§ÛŒ Ø¨ÛŒâ€ŒÙ†Ù‡Ø§ÛŒØª Ø¨Ø±Ø§ÛŒ Ù†Ú¯Ù‡â€ŒØ¯Ø§Ø±ÛŒ workflow
        while true; do
            # Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§
            if [ -f "dns.pid" ] && ps -p $(cat dns.pid) >/dev/null 2>&1; then
                echo "âœ… Python DNS: Active - $(date +'%H:%M:%S')"
            else
                echo "ðŸ”„ Restarting DNS server..."
                nohup python3 dns_server.py > dns.log 2>&1 &
                echo $! > dns.pid
            fi
            
            if [ -f "ngrok.pid" ] && ps -p $(cat ngrok.pid) >/dev/null 2>&1; then
                echo "âœ… Ngrok Tunnel: Active - $(date +'%H:%M:%S')"
            else
                echo "ðŸ”„ Restarting Ngrok..."
                ./ngrok tcp 5353 --log=stdout > ngrok.log 2>&1 &
                echo $! > ngrok.pid
            fi
            
            # ØªØ³Øª Ø§ØªØµØ§Ù„ Ù‡Ø± 30 Ø«Ø§Ù†ÛŒÙ‡
            sleep 30
        done
