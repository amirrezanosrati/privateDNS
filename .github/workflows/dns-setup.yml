name: Mobile Legends DNS Server
on:
  workflow_dispatch:

jobs:
  dns-server:
    runs-on: ubuntu-latest
    steps:
    - name: Install required packages
      run: |
        sudo apt-get update
        sudo apt-get install -y dnsmasq dnsutils

    - name: Setup dnsmasq configuration
      run: |
        # ایجاد پیکربندی ساده با آدرس‌های معتبر
        sudo tee /etc/dnsmasq.conf > /dev/null << EOF
        port=5353
        listen-address=127.0.0.1
        server=8.8.8.8
        server=1.1.1.1
        address=/mlbb.com/104.16.121.233
        address=/mobilelegends.com/104.18.122.45
        # حذف آدرس نامعتبر moonton.com
        no-hosts
        no-resolv
        EOF

    - name: Run dnsmasq manually
      run: |
        # توقف سرویس‌های قبلی
        sudo pkill dnsmasq || true
        sleep 2
        
        # اجرای dnsmasq روی پورت 5353
        sudo dnsmasq --port=5353 --no-daemon &
        sleep 3
        
        # تست DNS با dig
        echo "Testing DNS server..."
        dig @127.0.0.1 -p 5353 mlbb.com +short && echo "✅ DNS server is working"

    - name: Download Ngrok
      run: |
        # دانلود ngrok
        curl -s https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz -o ngrok.tgz
        tar -xzf ngrok.tgz
        chmod +x ngrok

    - name: Setup Ngrok authentication
      run: |
        ./ngrok authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
        echo "✅ Ngrok authenticated"

    - name: Start Ngrok tunnel
      run: |
        # راه‌اندازی تونل
        ./ngrok tcp 5353 --log=stdout > ngrok.log 2>&1 &
        sleep 20
        
        # دریافت آدرس تونل
        TUNNEL_URL=$(curl -s http://localhost:4040/api/tunnels | grep -o "tcp://[^\"]*" | head -1 || echo "")
        if [ -n "$TUNNEL_URL" ]; then
            echo "🌐 Tunnel URL: $TUNNEL_URL"
            DNS_IP=$(echo "$TUNNEL_URL" | cut -d':' -f2 | sed 's#//##')
            DNS_PORT=$(echo "$TUNNEL_URL" | cut -d':' -f3)
        else
            # استفاده از آدرس پیش‌فرض
            DNS_IP="0.tcp.ngrok.io"
            DNS_PORT="5353"
            echo "⚠️ Using default ngrok address"
        fi
        
        echo "DNS_IP=$DNS_IP" >> $GITHUB_ENV
        echo "DNS_PORT=$DNS_PORT" >> $GITHUB_ENV

    - name: Display connection information
      run: |
        echo "========================================"
        echo "🎯 MOBILE LEGENDS DNS SERVER READY!"
        echo "========================================"
        echo "📱 DNS IP: ${{ env.DNS_IP }}"
        echo "🔌 DNS Port: ${{ env.DNS_PORT }}"
        echo ""
        echo "💡 در DNS Changer گوشی وارد کنید:"
        echo "Address: ${{ env.DNS_IP }}"
        echo "Port: ${{ env.DNS_PORT }}"
        echo "========================================"

    - name: Keep workflow running
      run: |
        echo "🟢 Server is running..."
        echo "⏰ Press 'Cancel workflow' to stop"
        
        # حلقه بی‌نهایت ساده
        while true; do
            echo "✅ Still running at $(date +'%H:%M:%S')"
            sleep 60
        done
