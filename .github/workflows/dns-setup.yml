name: Personal DNS Server
on:
  workflow_dispatch:

jobs:
  dns-server:
    runs-on: ubuntu-latest
    steps:
    - name: Install dnsmasq
      run: |
        sudo apt-get update
        # Ù†ØµØ¨ ÙÙ‚Ø· dnsmasq Ø¨Ø¯ÙˆÙ† Ø¨Ø³ØªÙ‡â€ŒÙ‡Ø§ÛŒ Ø§Ø¶Ø§ÙÛŒ
        sudo apt-get install -y dnsmasq --no-install-recommends
        echo "âœ… dnsmasq installed successfully"

    - name: Stop conflicting services
      run: |
        # ØªÙˆÙ‚Ù Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§ÛŒ ØªØ¯Ø§Ø®Ù„â€ŒÚ©Ù†Ù†Ø¯Ù‡
        sudo systemctl stop systemd-resolved || true
        sudo systemctl disable systemd-resolved || true
        sudo systemctl mask systemd-resolved || true
        
        # Ø¢Ø²Ø§Ø¯ Ú©Ø±Ø¯Ù† Ù¾ÙˆØ±Øª 53
        sudo pkill -f dnsmasq || true
        sudo pkill -f systemd-resolve || true
        sleep 2

    - name: Create dnsmasq configuration
      run: |
        # Ø§ÛŒØ¬Ø§Ø¯ Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ dnsmasq
        sudo tee /etc/dnsmasq.conf > /dev/null << EOF
        interface=lo
        listen-address=127.0.0.1
        bind-interfaces
        server=8.8.8.8
        server=1.1.1.1
        address=/steam.com/104.112.119.210
        address=/epicgames.com/104.16.109.18
        address=/origin.com/104.112.119.210
        address=/battle.net/104.16.109.18
        no-hosts
        no-resolv
        cache-size=1000
        no-dhcp-interface=
        EOF

    - name: Start dnsmasq manually (no systemd)
      run: |
        # Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø¯Ø³ØªÛŒ dnsmasq Ø¨Ø¯ÙˆÙ† systemd
        sudo pkill -f dnsmasq || true
        sleep 2
        
        # Ø§Ø¬Ø±Ø§ÛŒ dnsmasq Ø¯Ø± Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡
        sudo dnsmasq --no-daemon --conf-file=/etc/dnsmasq.conf --log-queries &
        DNSMASQ_PID=$!
        echo $DNSMASQ_PID > dnsmasq.pid
        sleep 3
        
        # ØªØ³Øª DNS
        echo "Testing DNS server..."
        if nslookup steam.com 127.0.0.1; then
            echo "âœ… DNS server is working!"
        else
            echo "âŒ DNS server failed - checking process..."
            ps aux | grep dnsmasq
            exit 1
        fi

    - name: Download and setup Ngrok
      run: |
        # Ø¯Ø§Ù†Ù„ÙˆØ¯ ngrok
        wget -q https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz
        tar -xzf ngrok-v3-stable-linux-amd64.tgz
        chmod +x ngrok
        
        # ØªÙ†Ø¸ÛŒÙ… auth token
        ./ngrok authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
        
        # Ø±Ø§Ù‡ Ø§Ù†Ø¯Ø§Ø²ÛŒ ØªÙˆÙ†Ù„ Ø¨Ø±Ø§ÛŒ Ù¾ÙˆØ±Øª 53
        ./ngrok tcp 53 --log=stdout > ngrok.log 2>&1 &
        echo $! > ngrok.pid
        echo "ðŸ”„ Starting ngrok tunnel..."
        sleep 20

    - name: Get connection information
      run: |
        # Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØªÙˆÙ†Ù„
        echo "Getting tunnel information..."
        
        # Ø±ÙˆØ´ Ù…Ø³ØªÙ‚ÛŒÙ… Ø§Ø² log
        if [ -f "ngrok.log" ]; then
            TUNNEL_URL=$(grep -o "url=tcp://[^ ]*" ngrok.log | head -1 | cut -d'=' -f2 || echo "")
            if [ -n "$TUNNEL_URL" ]; then
                DNS_IP=$(echo "$TUNNEL_URL" | cut -d':' -f2 | sed 's#//##')
                DNS_PORT=$(echo "$TUNNEL_URL" | cut -d':' -f3)
            else
                # Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø¢Ø¯Ø±Ø³ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ ngrok
                DNS_IP="0.tcp.ngrok.io"
                DNS_PORT="53"
            fi
        else
            DNS_IP="0.tcp.ngrok.io"
            DNS_PORT="53"
        fi
        
        echo "ðŸŒ DNS_IP=$DNS_IP"
        echo "ðŸ”Œ DNS_PORT=$DNS_PORT"
        echo "DNS_IP=$DNS_IP" >> $GITHUB_ENV
        echo "DNS_PORT=$DNS_PORT" >> $GITHUB_ENV

    - name: Display connection info
      run: |
        echo "=========================================="
        echo "ðŸŽ¯ YOUR PERSONAL DNS SERVER IS READY!"
        echo "=========================================="
        echo "ðŸ”¢ DNS IP: ${{ env.DNS_IP }}"
        echo "ðŸ”Œ DNS Port: ${{ env.DNS_PORT }}"
        echo ""
        echo "ðŸ“± Ø¯Ø± Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† DNS Changer Ú¯ÙˆØ´ÛŒ:"
        echo "Primary DNS: ${{ env.DNS_IP }}"
        echo "Port: ${{ env.DNS_PORT }}"
        echo ""
        echo "ðŸ”§ Test connection:"
        echo "nslookup steam.com ${{ env.DNS_IP }}"
        echo "=========================================="

    - name: Keep alive and monitor
      run: |
        echo "ðŸŸ¢ DNS Server is running..."
        echo "ðŸ’¡ Press the 'Cancel workflow' button in GitHub to stop"
        echo ""
        
        COUNTER=0
        while true; do
            COUNTER=$((COUNTER + 1))
            echo "â° Running for $((COUNTER * 30)) seconds..."
            
            # ØªØ³Øª Ø³Ù„Ø§Ù…Øª DNS
            if nslookup steam.com 127.0.0.1 >/dev/null 2>&1; then
                echo "âœ… DNS Server: Healthy"
            else
                echo "âŒ DNS Server: Not responding - restarting..."
                sudo pkill -f dnsmasq || true
                sudo dnsmasq --no-daemon --conf-file=/etc/dnsmasq.conf &
                sleep 5
            fi
            
            # ØªØ³Øª Ø³Ù„Ø§Ù…Øª Ngrok
            if [ -f "ngrok.pid" ] && ps -p $(cat ngrok.pid) >/dev/null 2>&1; then
                echo "âœ… Ngrok Tunnel: Active"
            else
                echo "âŒ Ngrok Tunnel: Down - restarting..."
                pkill -f ngrok || true
                ./ngrok tcp 53 --log=stdout > ngrok.log 2>&1 &
                echo $! > ngrok.pid
                sleep 15
            fi
            
            sleep 30
        done
