name: Cloudflare Tunnel VPN

on:
  workflow_dispatch

jobs:
  deploy-cf-tunnel:
    runs-on: ubuntu-latest
    steps:
    - name: Install Cloudflared
      run: |
        wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
        sudo dpkg -i cloudflared-linux-amd64.deb
        
    - name: Authenticate Cloudflare
      run: |
        echo "${{ secrets.CLOUDFLARE_ACCOUNT_ID }}" > account_id
        echo "${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }}" > tunnel_token
        
    - name: Create tunnel
      run: |
        cloudflared tunnel create github-vpn
        cloudflared tunnel route dns github-vpn vpn.$GITHUB_REPOSITORY_OWNER.github.com
        
    - name: Configure and run tunnel
      run: |
        cloudflared tunnel run github-vpn > cloudflared.log 2>&1 &
        sleep 10
