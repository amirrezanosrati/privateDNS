name: OpenVPN Server

on:
  workflow_dispatch

jobs:
  deploy-openvpn:
    runs-on: ubuntu-latest
    steps:
    - name: Install OpenVPN
      run: |
        sudo apt-get update
        sudo apt-get install -y openvpn

    - name: Create minimal OpenVPN config
      run: |
        # Ø§ÛŒØ¬Ø§Ø¯ ÛŒÚ© Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ Ø¨Ø³ÛŒØ§Ø± Ø³Ø§Ø¯Ù‡
        sudo mkdir -p /etc/openvpn
        
        # Ø§ÛŒØ¬Ø§Ø¯ ÙØ§ÛŒÙ„ Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ Ø§ØµÙ„ÛŒ
        sudo tee /etc/openvpn/server.conf > /dev/null << 'EOF'
port 1194
proto udp
dev tun
secret /etc/openvpn/static.key
ifconfig 10.8.0.1 10.8.0.2
route 10.8.0.0 255.255.255.0
keepalive 10 120
cipher AES-256-CBC
persist-key
persist-tun
status /var/log/openvpn-status.log
verb 3
EOF

        # Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù„ÛŒØ¯ Ø§Ø³ØªØ§ØªÛŒÚ© Ø³Ø§Ø¯Ù‡
        sudo tee /etc/openvpn/static.key > /dev/null << 'EOF'
#
# 2048 bit OpenVPN static key
#
-----BEGIN OpenVPN Static key V1-----
e685f2d6cd8b7c7f8e4c6b7a1d6e8f3b
4c2d8e7f3a1b6c9d8e7f2a4b6c8d9e1f
3a5c7e9d1f2b4a6c8e7d9f1a3b5c7e9d
2f4a6c8e1d3b5f7a9c8e2b4d6f8a1c3e
5d7f9a2b4c6e8d1f3a5c7e9b1d3f5a7c
9e2b4d6f8a1c3e5d7f9b2d4f6a8c1e3
5a7c9e2b4d6f8a1c3e5d7f9b2d4f6a8
c1e3f5a7c9e2b4d6f8a1c3e5d7f9b2d
4f6a8c1e3f5a7c9e2b4d6f8a1c3e5d7
f9b2d4f6a8c1e3f5a7c9e2b4d6f8a1c
3e5d7f9b2d4f6a8c1e3f5a7c9e2b4d6
f8a1c3e5d7f9b2d4f6a8c1e3f5a7c9e
2b4d6f8a1c3e5d7f9b2d4f6a8c1e3f5
a7c9e2b4d6f8a1c3e5d7f9b2d4f6a8c
1e3f5a7c9e2b4d6f8a1c3e5d7f9b2d4
f6a8c1e3f5a7c9e2b4d6f8a1c3e5d7f
-----END OpenVPN Static key V1-----
EOF

    - name: Start OpenVPN
      run: |
        # Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ OpenVPN
        sudo openvpn --daemon --config /etc/openvpn/server.conf
        sleep 3
        
        # Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª
        if pgrep openvpn; then
          echo "âœ… OpenVPN started successfully"
        else
          echo "âŒ OpenVPN failed to start - trying direct execution"
          sudo /usr/sbin/openvpn --config /etc/openvpn/server.conf --daemon
          sleep 3
          if pgrep openvpn; then
            echo "âœ… OpenVPN started with direct execution"
          else
            echo "âŒ OpenVPN still failed to start"
            echo "Trying one more method..."
            sudo bash -c "cd /etc/openvpn && /usr/sbin/openvpn server.conf --daemon"
            sleep 3
            if pgrep openvpn; then
              echo "âœ… OpenVPN started with alternative method"
            else
              echo "âŒ All OpenVPN start methods failed"
              exit 1
            fi
          fi
        fi

    - name: Setup Ngrok
      run: |
        # Ø¯Ø§Ù†Ù„ÙˆØ¯ Ngrok
        wget -q https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz
        tar -xzf ngrok-v3-stable-linux-amd64.tgz
        chmod +x ngrok
        
        # ØªÙ†Ø¸ÛŒÙ… ØªÙˆÚ©Ù†
        ./ngrok authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
        
        # Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ ØªÙˆÙ†Ù„
        ./ngrok udp 1194 > /dev/null 2>&1 &
        echo "Ngrok started for UDP port 1194"
        sleep 5

    - name: Get connection info
      run: |
        # Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØªÙˆÙ†Ù„
        sleep 5
        echo "Trying to get tunnel info..."
        
        # Ú†Ù†Ø¯ÛŒÙ† Ø±ÙˆØ´ Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª
        TUNNEL_INFO=$(curl -s http://localhost:4040/api/tunnels 2>/dev/null || echo "{}")
        
        if echo "$TUNNEL_INFO" | grep -q "udp://"; then
          SERVER_URL=$(echo "$TUNNEL_INFO" | grep -o "udp://[^,\"]*" | head -1)
          SERVER_IP=$(echo "$SERVER_URL" | cut -d':' -f2 | sed 's#//##')
          SERVER_PORT=$(echo "$SERVER_URL" | cut -d':' -f3)
          echo "âœ… Found UDP tunnel: $SERVER_IP:$SERVER_PORT"
        else
          # Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø¢Ø¯Ø±Ø³ Ù¾ÛŒØ´â€ŒÙØ±Ø¶
          SERVER_IP="0.udp.ngrok.io"
          SERVER_PORT="1194"
          echo "âš ï¸  Using default server: $SERVER_IP:$SERVER_PORT"
        fi
        
        echo "SERVER_IP=$SERVER_IP" >> $GITHUB_ENV
        echo "SERVER_PORT=$SERVER_PORT" >> $GITHUB_ENV

    - name: Create client config
      run: |
        # Ø§ÛŒØ¬Ø§Ø¯ Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ Ú©Ù„Ø§ÛŒÙ†Øª
        sudo tee /tmp/client.ovpn > /dev/null << EOF
client
dev tun
proto udp
remote ${{ env.SERVER_IP }} ${{ env.SERVER_PORT }}
resolv-retry infinite
nobind
persist-key
persist-tun
cipher AES-256-CBC
verb 3

# Ú©Ù„ÛŒØ¯ Ø§Ø³ØªØ§ØªÛŒÚ©
<secret>
-----BEGIN OpenVPN Static key V1-----
e685f2d6cd8b7c7f8e4c6b7a1d6e8f3b
4c2d8e7f3a1b6c9d8e7f2a4b6c8d9e1f
3a5c7e9d1f2b4a6c8e7d9f1a3b5c7e9d
2f4a6c8e1d3b5f7a9c8e2b4d6f8a1c3e
5d7f9a2b4c6e8d1f3a5c7e9b1d3f5a7c
9e2b4d6f8a1c3e5d7f9b2d4f6a8c1e3
5a7c9e2b4d6f8a1c3e5d7f9b2d4f6a8
c1e3f5a7c9e2b4d6f8a1c3e5d7f9b2d
4f6a8c1e3f5a7c9e2b4d6f8a1c3e5d7
f9b2d4f6a8c1e3f5a7c9e2b4d6f8a1c
3e5d7f9b2d4f6a8c1e3f5a7c9e2b4d6
f8a1c3e5d7f9b2d4f6a8c1e3f5a7c9e
2b4d6f8a1c3e5d7f9b2d4f6a8c1e3f5
a7c9e2b4d6f8a1c3e5d7f9b2d4f6a8c
1e3f5a7c9e2b4d6f8a1c3e5d7f9b2d4
f6a8c1e3f5a7c9e2b4d6f8a1c3e5d7f
-----END OpenVPN Static key V1-----
</secret>
EOF

        # Ø°Ø®ÛŒØ±Ù‡ Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ
        CLIENT_CONFIG=$(cat /tmp/client.ovpn)
        echo "CLIENT_CONFIG<<EOF" >> $GITHUB_ENV
        echo "$CLIENT_CONFIG" >> $GITHUB_ENV
        echo "EOF" >> $GITHUB_ENV

    - name: Show connection details
      run: |
        echo "=========================================="
        echo "ğŸš€ OpenVPN Server Ready!"
        echo "=========================================="
        echo "ğŸ“¡ Server: ${{ env.SERVER_IP }}"
        echo "ğŸšª Port: ${{ env.SERVER_PORT }}"
        echo "ğŸ“‹ Protocol: UDP"
        echo "ğŸ” Encryption: Static Key"
        echo ""
        echo "ğŸ”§ Client Configuration:"
        echo "Copy the content below to a file with .ovpn extension:"
        echo "=========================================="
        echo "${{ env.CLIENT_CONFIG }}"
        echo "=========================================="
        echo "ğŸ’¡ Import this .ovpn file in your OpenVPN client"
        echo "â° This server will be active for 6 hours"
        echo "=========================================="

    - name: Keep alive
      run: |
        echo "ğŸŸ¢ Server is running..."
        echo "OpenVPN process: $(pgrep openvpn || echo 'Not found')"
        echo "Ngrok process: $(pgrep ngrok || echo 'Not found')"
        
        # Ù†Ú¯Ù‡â€ŒØ¯Ø§Ø±ÛŒ Ø³Ø±ÙˆØ± Ø¨Ø±Ø§ÛŒ 6 Ø³Ø§Ø¹Øª
        sleep 21600
