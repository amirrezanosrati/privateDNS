name: Auto-Fallback VPN

on:
  workflow_dispatch

jobs:
  deploy-smart-vpn:
    runs-on: ubuntu-latest
    steps:
    - name: Try multiple methods
      run: |
        # Ø±ÙˆØ´ Ø§ÙˆÙ„: Docker
        if command -v docker &> /dev/null; then
          echo "ðŸ³ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Docker"
          docker run -d -p 1080:1080 serjs/go-socks5-proxy
          echo "METHOD=docker" >> $GITHUB_ENV
          echo "PORT=1080" >> $GITHUB_ENV
          
        # Ø±ÙˆØ´ Ø¯ÙˆÙ…: Podman
        elif command -v podman &> /dev/null; then
          echo "ðŸ“¦ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Podman"
          podman run -d -p 1080:1080 docker.io/serjs/go-socks5-proxy
          echo "METHOD=podman" >> $GITHUB_ENV
          echo "PORT=1080" >> $GITHUB_ENV
          
        # Ø±ÙˆØ´ Ø³ÙˆÙ…: Ù†Ø±Ù…â€ŒØ§ÙØ²Ø§Ø± Ù…Ø³ØªÙ‚ÛŒÙ…
        else
          echo "âš¡ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø±ÙˆØ´ Ù…Ø³ØªÙ‚ÛŒÙ…"
          sudo apt-get install -y tinyproxy
          sudo sed -i 's/^Port 8888/Port 8080/' /etc/tinyproxy/tinyproxy.conf
          sudo systemctl restart tinyproxy
          echo "METHOD=direct" >> $GITHUB_ENV
          echo "PORT=8080" >> $GITHUB_ENV
        fi

    - name: Setup tunnel
      run: |
        curl -s https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz | tar xz
        chmod +x ngrok
        ./ngrok authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
        ./ngrok tcp ${{ env.PORT }} > ngrok.log 2>&1 &
        sleep 10

    - name: Display info
      run: |
        echo "âœ… Ø³Ø±ÙˆÛŒØ³ Ø¨Ø§ Ø±ÙˆØ´ ${{ env.METHOD }} Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø´Ø¯"
        echo "ðŸ”Œ Ù¾ÙˆØ±Øª: ${{ env.PORT }}"
