name: OpenVPN Server

on:
  workflow_dispatch

jobs:
  deploy-openvpn:
    runs-on: ubuntu-latest
    steps:
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y openvpn easy-rsa curl

    - name: Setup OpenVPN environment
      run: |
        # Ø§ÛŒØ¬Ø§Ø¯ Ø¯Ø§ÛŒØ±Ú©ØªÙˆØ±ÛŒâ€ŒÙ‡Ø§ÛŒ Ù„Ø§Ø²Ù…
        sudo mkdir -p /etc/openvpn/{server,client}
        cd /etc/openvpn

    - name: Generate SSL certificates
      run: |
        # Ú©Ù¾ÛŒ easy-rsa
        sudo cp -r /usr/share/easy-rsa/* /etc/openvpn/
        cd /etc/openvpn
        
        # Initialize PKI
        printf "\n" | sudo ./easyrsa init-pki
        printf "\n" | sudo ./easyrsa build-ca nopass
        
        # Generate server certificate
        printf "server\n" | sudo ./easyrsa gen-req server nopass
        printf "yes\n" | sudo ./easyrsa sign-req server server
        
        # Generate client certificate
        printf "client\n" | sudo ./easyrsa gen-req client nopass
        printf "yes\n" | sudo ./easyrsa sign-req client client
        
        # Generate DH parameters
        sudo ./easyrsa gen-dh
        
        # Generate TLS key
        sudo openvpn --genkey --secret pki/ta.key

    - name: Create server configuration
      run: |
        cd /etc/openvpn
        
        # Ø§ÛŒØ¬Ø§Ø¯ Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ Ø³Ø±ÙˆØ±
        sudo tee server.conf > /dev/null << 'EOF'
port 1194
proto udp
dev tun
ca /etc/openvpn/pki/ca.crt
cert /etc/openvpn/pki/issued/server.crt
key /etc/openvpn/pki/private/server.key
dh /etc/openvpn/pki/dh.pem
server 10.8.0.0 255.255.255.0
ifconfig-pool-persist ipp.txt
push "redirect-gateway def1 bypass-dhcp"
push "dhcp-option DNS 8.8.8.8"
push "dhcp-option DNS 8.8.4.4"
keepalive 10 120
tls-auth /etc/openvpn/pki/ta.key 0
cipher AES-256-CBC
persist-key
persist-tun
status openvpn-status.log
verb 3
explicit-exit-notify 1
user nobody
group nogroup
EOF

    - name: Start OpenVPN service
      run: |
        # ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† IP forwarding
        sudo sed -i 's/#net.ipv4.ip_forward=1/net.ipv4.ip_forward=1/g' /etc/sysctl.conf
        sudo sysctl -p
        
        # Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø³Ø±ÙˆÛŒØ³ OpenVPN
        sudo openvpn --daemon --config /etc/openvpn/server.conf --log /var/log/openvpn.log
        
        # Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª
        sleep 5
        if pgrep openvpn > /dev/null; then
          echo "âœ… OpenVPN started successfully"
          echo "OPENVPN_STARTED=true" >> $GITHUB_ENV
        else
          echo "âŒ OpenVPN failed to start"
          echo "Checking logs:"
          sudo cat /var/log/openvpn.log || echo "No log file found"
          exit 1
        fi

    - name: Setup Ngrok tunnel
      run: |
        # Ø¯Ø§Ù†Ù„ÙˆØ¯ Ùˆ Ù†ØµØ¨ Ngrok
        curl -s https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz | tar xz -C /tmp/
        chmod +x /tmp/ngrok
        
        # ØªÙ†Ø¸ÛŒÙ… ØªÙˆÚ©Ù†
        /tmp/ngrok authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
        
        # Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ ØªÙˆÙ†Ù„
        /tmp/ngrok udp 1194 --log stdout > /tmp/ngrok.log 2>&1 &
        
        # Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø±Ø§ÛŒ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ
        sleep 10
        
        # Ù†Ù…Ø§ÛŒØ´ Ù„Ø§Ú¯ Ø¨Ø±Ø§ÛŒ Ø¯ÛŒØ¨Ø§Ú¯
        echo "Ngrok log:"
        cat /tmp/ngrok.log | tail -20 || echo "No ngrok log found"

    - name: Get connection info
      run: |
        # Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØªÙˆÙ†Ù„
        sleep 10
        TUNNEL_INFO=$(curl -s http://localhost:4040/api/tunnels || echo "{}")
        
        # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§Ø² JSON
        SERVER_URL=$(echo "$TUNNEL_INFO" | grep -o '"public_url":"[^"]*"' | head -1 | cut -d'"' -f4)
        
        if [ -n "$SERVER_URL" ]; then
            SERVER_IP=$(echo "$SERVER_URL" | cut -d':' -f2 | sed 's#//##')
            SERVER_PORT=$(echo "$SERVER_URL" | cut -d':' -f3)
            echo "âœ… Ngrok tunnel established: $SERVER_IP:$SERVER_PORT"
        else
            # Fallback Ø§Ú¯Ø± Ngrok Ú©Ø§Ø± Ù†Ú©Ø±Ø¯
            SERVER_IP="0.udp.ngrok.io"
            SERVER_PORT="1194"
            echo "âš ï¸  Using fallback server address"
        fi
        
        echo "SERVER_IP=$SERVER_IP" >> $GITHUB_ENV
        echo "SERVER_PORT=$SERVER_PORT" >> $GITHUB_ENV

    - name: Create client configuration
      run: |
        # Ø§ÛŒØ¬Ø§Ø¯ Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ Ú©Ù„Ø§ÛŒÙ†Øª
        sudo tee /tmp/client.ovpn > /dev/null << EOF
client
dev tun
proto udp
remote ${{ env.SERVER_IP }} ${{ env.SERVER_PORT }}
resolv-retry infinite
nobind
persist-key
persist-tun
remote-cert-tls server
cipher AES-256-CBC
verb 3
key-direction 1

<ca>
$(sudo cat /etc/openvpn/pki/ca.crt)
</ca>

<cert>
$(sudo cat /etc/openvpn/pki/issued/client.crt)
</cert>

<key>
$(sudo cat /etc/openvpn/pki/private/client.key)
</key>

<tls-auth>
$(sudo cat /etc/openvpn/pki/ta.key)
</tls-auth>
EOF
        
        # Ø°Ø®ÛŒØ±Ù‡ Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ
        CLIENT_CONFIG=$(cat /tmp/client.ovpn)
        echo "CLIENT_CONFIG<<EOF" >> $GITHUB_ENV
        echo "$CLIENT_CONFIG" >> $GITHUB_ENV
        echo "EOF" >> $GITHUB_ENV

    - name: Display connection details
      run: |
        echo "=========================================="
        echo "ğŸš€ OpenVPN Server Ready!"
        echo "=========================================="
        echo "ğŸ“¡ Server: ${{ env.SERVER_IP }}"
        echo "ğŸšª Port: ${{ env.SERVER_PORT }}"
        echo "ğŸ“‹ Protocol: UDP"
        echo ""
        echo "ğŸ”§ Client Configuration:"
        echo "Copy the content below to a file with .ovpn extension:"
        echo "=========================================="
        echo "${{ env.CLIENT_CONFIG }}"
        echo "=========================================="
        echo "ğŸ’¡ Import this .ovpn file in your OpenVPN client"
        echo "â° This server will be active for 6 hours"
        echo "=========================================="

    - name: Keep server alive
      run: |
        echo "ğŸŸ¢ OpenVPN server is running for 6 hours..."
        # Ù†Ú¯Ù‡â€ŒØ¯Ø§Ø±ÛŒ Ø³Ø±ÙˆØ± Ø¨Ø±Ø§ÛŒ 6 Ø³Ø§Ø¹Øª
        sleep 21600
