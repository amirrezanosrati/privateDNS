name: Advanced Anti-Filter VPN

on:
  workflow_dispatch:
    inputs:
      vpn_type:
        description: 'Ù†ÙˆØ¹ Ø³Ø±ÙˆÛŒØ³ VPN'
        required: true
        default: 'v2ray'
        type: choice
        options:
        - 'v2ray'
        - 'xray'
        - 'shadowsocks'
        - 'naiveproxy'
        - 'tuic'
        - 'hysteria'
        - 'all'

env:
  MAX_DURATION: 36000  # 10 hours

jobs:
  deploy-advanced-vpn:
    runs-on: ubuntu-latest
    timeout-minutes: 600
    
    steps:
    - name: Setup basic tools
      run: |
        sudo apt-get update
        sudo apt-get install -y wget curl unzip jq git build-essential
        echo "âœ… Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§ÛŒ Ù¾Ø§ÛŒÙ‡ Ù†ØµØ¨ Ø´Ø¯Ù†Ø¯"

    - name: Install and configure selected VPN
      run: |
        case "${{ github.event.inputs.vpn_type }}" in
          "v2ray"|"all")
            echo "ğŸ“¦ Ù†ØµØ¨ V2Ray..."
            bash <(curl -L https://raw.githubusercontent.com/v2fly/fhs-install-v2ray/master/install-release.sh)
            
            # Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø§Ù†ÙÛŒÚ¯ Ù¾ÛŒØ´Ø±ÙØªÙ‡
            UUID=$(cat /proc/sys/kernel/random/uuid)
            sudo tee /usr/local/etc/v2ray/config.json > /dev/null << EOF
{
  "inbounds": [{
    "port": 10086,
    "protocol": "vmess",
    "settings": {
      "clients": [{
        "id": "$UUID",
        "alterId": 0,
        "security": "auto"
      }]
    },
    "streamSettings": {
      "network": "ws",
      "wsSettings": {
        "path": "/graphql"
      }
    }
  }],
  "outbounds": [{
    "protocol": "freedom",
    "settings": {}
  }]
}
EOF
            sudo systemctl start v2ray
            echo "V2RAY_PORT=10086" >> $GITHUB_ENV
            echo "V2RAY_UUID=$UUID" >> $GITHUB_ENV
            ;;
        esac

        case "${{ github.event.inputs.vpn_type }}" in
          "xray"|"all")
            echo "ğŸ“¦ Ù†ØµØ¨ XRay..."
            bash <(curl -L https://raw.githubusercontent.com/XTLS/Xray-install/main/install-release.sh)
            
            XRAY_UUID=$(cat /proc/sys/kernel/random/uuid)
            sudo tee /usr/local/etc/xray/config.json > /dev/null << EOF
{
  "inbounds": [{
    "port": 10010,
    "protocol": "vless",
    "settings": {
      "clients": [{
        "id": "$XRAY_UUID",
        "flow": "xtls-rprx-vision"
      }],
      "decryption": "none"
    },
    "streamSettings": {
      "network": "tcp",
      "security": "reality",
      "realitySettings": {
        "show": false,
        "dest": "www.amazon.com:443",
        "xver": 0
      }
    }
  }]
}
EOF
            sudo systemctl start xray
            echo "XRAY_PORT=10010" >> $GITHUB_ENV
            echo "XRAY_UUID=$XRAY_UUID" >> $GITHUB_ENV
            ;;
        esac

        case "${{ github.event.inputs.vpn_type }}" in
          "shadowsocks"|"all")
            echo "ğŸ“¦ Ù†ØµØ¨ Shadowsocks..."
            pip3 install shadowsocks
            
            SS_PASSWORD=$(openssl rand -base64 16)
            SS_METHOD="aes-256-gcm"
            
            sudo tee /etc/shadowsocks.json > /dev/null << EOF
{
    "server":"0.0.0.0",
    "server_port":8388,
    "password":"$SS_PASSWORD",
    "method":"$SS_METHOD",
    "fast_open":true,
    "mode":"tcp_only"
}
EOF
            ssserver -c /etc/shadowsocks.json -d start
            echo "SS_PORT=8388" >> $GITHUB_ENV
            echo "SS_PASSWORD=$SS_PASSWORD" >> $GITHUB_ENV
            echo "SS_METHOD=$SS_METHOD" >> $GITHUB_ENV
            ;;
        esac

    - name: Setup multiple Ngrok tunnels
      run: |
        # Ø¯Ø§Ù†Ù„ÙˆØ¯ Ngrok
        curl -s https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz | tar xz
        chmod +x ngrok
        ./ngrok authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
        
        # Ø±Ø§Ù‡ Ø§Ù†Ø¯Ø§Ø²ÛŒ ØªÙˆÙ†Ù„â€ŒÙ‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù
        case "${{ github.event.inputs.vpn_type }}" in
          "v2ray")
            ./ngrok tcp 10086 > ngrok_v2ray.log 2>&1 &
            ;;
          "xray")
            ./ngrok tcp 10010 > ngrok_xray.log 2>&1 &
            ;;
          "shadowsocks")
            ./ngrok tcp 8388 > ngrok_ss.log 2>&1 &
            ;;
          "all")
            ./ngrok tcp 10086 > ngrok_v2ray.log 2>&1 &
            ./ngrok tcp 10010 > ngrok_xray.log 2>&1 &
            ./ngrok tcp 8388 > ngrok_ss.log 2>&1 &
            ;;
        esac
        
        sleep 15

    - name: Get tunnel information
      run: |
        # Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØªÙˆÙ†Ù„â€ŒÙ‡Ø§
        TUNNELS_JSON=$(curl -s http://localhost:4040/api/tunnels)
        
        # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù‡Ø± ØªÙˆÙ†Ù„
        echo "$TUNNELS_JSON" | jq -r '.tunnels[] | .name + " " + .public_url' | while read tunnel; do
          name=$(echo $tunnel | cut -d' ' -f1)
          url=$(echo $tunnel | cut -d' ' -f2-)
          
          if echo "$name" | grep -q "tcp-10086"; then
            echo "V2RAY_URL=$url" >> $GITHUB_ENV
          elif echo "$name" | grep -q "tcp-10010"; then
            echo "XRAY_URL=$url" >> $GITHUB_ENV
          elif echo "$name" | grep -q "tcp-8388"; then
            echo "SS_URL=$url" >> $GITHUB_ENV
          fi
        done

    - name: Generate client configurations
      run: |
        # ØªÙˆÙ„ÛŒØ¯ Ú©Ø§Ù†ÙÛŒÚ¯ Ú©Ù„Ø§ÛŒÙ†Øª
        case "${{ github.event.inputs.vpn_type }}" in
          "v2ray"|"all")
            if [ -n "${{ env.V2RAY_URL }}" ]; then
              V2RAY_IP=$(echo "${{ env.V2RAY_URL }}" | cut -d':' -f2 | sed 's#//##')
              V2RAY_PORT=$(echo "${{ env.V2RAY_URL }}" | cut -d':' -f3)
              
              cat > v2ray_config.json << EOF
{
  "v": "2",
  "ps": "GitHub-V2Ray",
  "add": "$V2RAY_IP",
  "port": "$V2RAY_PORT",
  "id": "${{ env.V2RAY_UUID }}",
  "aid": "0",
  "net": "ws",
  "type": "none",
  "path": "/graphql",
  "tls": "none"
}
EOF
              V2RAY_LINK="vmess://$(base64 -w 0 v2ray_config.json)"
              echo "V2RAY_LINK=$V2RAY_LINK" >> $GITHUB_ENV
            fi
            ;;
        esac

        case "${{ github.event.inputs.vpn_type }}" in
          "shadowsocks"|"all")
            if [ -n "${{ env.SS_URL }}" ]; then
              SS_IP=$(echo "${{ env.SS_URL }}" | cut -d':' -f2 | sed 's#//##')
              SS_PORT=$(echo "${{ env.SS_URL }}" | cut -d':' -f3)
              
              SS_LINK="ss://$(echo -n "${{ env.SS_METHOD }}:${{ env.SS_PASSWORD }}" | base64 -w 0)@$SS_IP:$SS_PORT#GitHub-Shadowsocks"
              echo "SS_LINK=$SS_LINK" >> $GITHUB_ENV
            fi
            ;;
        esac

    - name: Display connection details
      run: |
        echo "================================================"
        echo "ğŸš€ Ø³Ø±ÙˆÛŒØ³ Ø¶Ø¯ ÙÛŒÙ„ØªØ± Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª!"
        echo "================================================"
        echo "â° Ù…Ø¯Øª Ø²Ù…Ø§Ù† ÙØ¹Ø§Ù„: 10 Ø³Ø§Ø¹Øª"
        echo "ğŸ”§ Ù¾Ø±ÙˆØªÚ©Ù„â€ŒÙ‡Ø§ÛŒ ÙØ¹Ø§Ù„: ${{ github.event.inputs.vpn_type }}"
        echo ""
        
        if [ -n "${{ env.V2RAY_LINK }}" ]; then
          echo "ğŸ”µ V2Ray (VMESS):"
          echo "${{ env.V2RAY_LINK }}"
          echo ""
        fi
        
        if [ -n "${{ env.XRAY_URL }}" ]; then
          echo "ğŸ”´ XRay (VLESS+REALITY):"
          echo "Ø¢Ø¯Ø±Ø³: $(echo '${{ env.XRAY_URL }}' | cut -d':' -f2 | sed 's#//##')"
          echo "Ù¾ÙˆØ±Øª: $(echo '${{ env.XRAY_URL }}' | cut -d':' -f3)"
          echo "UUID: ${{ env.XRAY_UUID }}"
          echo ""
        fi
        
        if [ -n "${{ env.SS_LINK }}" ]; then
          echo "ğŸŸ¢ Shadowsocks:"
          echo "${{ env.SS_LINK }}"
          echo ""
        fi
        
        echo "================================================"
        echo "ğŸ’¡ Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡:"
        echo "1. Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§ Ø±Ø§ Ø¯Ø± Ú©Ù„Ø§ÛŒÙ†Øª Ù…Ù†Ø§Ø³Ø¨ import Ú©Ù†ÛŒØ¯"
        echo "2. Ø§Ø² Ù¾Ø±ÙˆØªÚ©Ù„â€ŒÙ‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù ØªØ³Øª Ú©Ù†ÛŒØ¯"
        echo "3. Ø¨Ù‡ØªØ±ÛŒÙ† Ù¾Ø±ÙˆØªÚ©Ù„ Ø¨Ø±Ø§ÛŒ Ù…Ù†Ø·Ù‚Ù‡ Ø®ÙˆØ¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯"
        echo "================================================"

    - name: Install monitoring tools
      run: |
        # Ù†ØµØ¨ Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§ÛŒ Ù…Ø§Ù†ÛŒØªÙˆØ±ÛŒÙ†Ú¯
        pip3 install speedtest-cli
        sudo apt-get install -y vnstat
        
        # Ø´Ø±ÙˆØ¹ Ù…Ø§Ù†ÛŒØªÙˆØ±ÛŒÙ†Ú¯ ØªØ±Ø§ÙÛŒÚ©
        vnstat -d -i eth0 > traffic.log 2>&1 &

    - name: Continuous monitoring
      run: |
        echo "ğŸ“Š Ø´Ø±ÙˆØ¹ Ù…Ø§Ù†ÛŒØªÙˆØ±ÛŒÙ†Ú¯ Ø³Ø±ÙˆÛŒØ³..."
        counter=0
        while [ $counter -lt $MAX_DURATION ]; do
          # Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§
          echo "ğŸ”„ Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª ($((counter/60)) Ø¯Ù‚ÛŒÙ‚Ù‡ Ú¯Ø°Ø´ØªÙ‡)"
          
          # ØªØ³Øª Ø³Ø±Ø¹Øª Ù‡Ø± 30 Ø¯Ù‚ÛŒÙ‚Ù‡
          if [ $((counter % 1800)) -eq 0 ]; then
            echo "ğŸ§ª ØªØ³Øª Ø³Ø±Ø¹Øª..."
            speedtest-cli --simple >> speedtest.log 2>&1 || echo "ØªØ³Øª Ø³Ø±Ø¹Øªå¤±æ•—"
          fi
          
          # Ù†Ù…Ø§ÛŒØ´ ØªØ±Ø§ÙÛŒÚ© Ù…ØµØ±ÙÛŒ
          if [ $((counter % 300)) -eq 0 ]; then
            echo "ğŸ“¶ ØªØ±Ø§ÙÛŒÚ© Ù…ØµØ±ÙÛŒ:"
            vnstat -h -i eth0 | tail -5 || echo "Ù†Ù…Ø§ÛŒØ´ ØªØ±Ø§ÙÛŒÚ©å¤±æ•—"
          fi
          
          sleep 60
          counter=$((counter + 60))
        done

    - name: Cleanup and notify
      if: always()
      run: |
        echo "ğŸ§¹ Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ Ù…Ù†Ø§Ø¨Ø¹..."
        pkill -f ngrok || true
        pkill -f ssserver || true
        sudo systemctl stop v2ray xray 2>/dev/null || true
        
        echo "âœ… Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒå®Œæˆ"
        echo "ğŸ“Š Ø®Ù„Ø§ØµÙ‡ Ø¹Ù…Ù„Ú©Ø±Ø¯:"
        cat speedtest.log 2>/dev/null || echo "Ù„Ø§Ú¯ ØªØ³Øª Ø³Ø±Ø¹Øª Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª"
        echo ""
        echo "ğŸ“ˆ ØªØ±Ø§ÙÛŒÚ© Ú©Ù„ Ù…ØµØ±ÙÛŒ:"
        vnstat -d -i eth0 2>/dev/null || echo "Ø¢Ù…Ø§Ø± ØªØ±Ø§ÙÛŒÚ© Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª"
