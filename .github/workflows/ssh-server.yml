name: SSH Server Creator

on:
  workflow_dispatch:
    inputs:
      ssh_password:
        description: 'SSH Password (leave empty for auto-generate)'
        required: false
        default: ''
        type: string

env:
  SSH_PASSWORD: ${{ github.event.inputs.ssh_password }}

jobs:
  deploy-ssh:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install SSH server
      run: |
        sudo apt-get update
        sudo apt-get install -y openssh-server

    - name: Configure SSH
      run: |
        # پیکربندی SSH
        sudo sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config
        sudo sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config
        
        # تولید رمز عبور اگر ارائه نشده
        if [ -z "$SSH_PASSWORD" ] || [ "$SSH_PASSWORD" = "" ]; then
          SSH_PASSWORD=$(openssl rand -base64 12)
          echo "SSH_PASSWORD=$SSH_PASSWORD" >> $GITHUB_ENV
        fi
        
        # تنظیم رمز عبور برای root
        echo "root:$SSH_PASSWORD" | sudo chpasswd
        
        # راه اندازی سرویس SSH
        sudo systemctl restart ssh
        
        echo "SSH_PORT=22" >> $GITHUB_ENV

    - name: Setup Ngrok tunnel
      run: |
        wget -q https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz
        tar -xzf ngrok-v3-stable-linux-amd64.tgz
        chmod +x ngrok
        
        ./ngrok authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
        ./ngrok tcp 22 --log=stdout > ngrok.log 2>&1 &
        sleep 10

    - name: Get connection info
      run: |
        # انتظار برای راه اندازی ngrok
        sleep 10
        
        # دریافت اطلاعات تونل
        TUNNEL_INFO=$(curl -s http://localhost:4040/api/tunnels | grep -o 'tcp://[^"]*' | head -1)
        
        if [ -n "$TUNNEL_INFO" ]; then
            SERVER_IP=$(echo "$TUNNEL_INFO" | cut -d':' -f2 | sed 's#//##')
            SERVER_PORT=$(echo "$TUNNEL_INFO" | cut -d':' -f3)
        else
            echo "Failed to get ngrok tunnel info, using defaults"
            SERVER_IP="0.tcp.ngrok.io"
            SERVER_PORT="10022"
        fi
        
        echo "SERVER_IP=$SERVER_IP" >> $GITHUB_ENV
        echo "SERVER_PORT=$SERVER_PORT" >> $GITHUB_ENV

    - name: Display connection details
      run: |
        echo "=========================================="
        echo "🚀 SSH SERVER READY!"
        echo "=========================================="
        echo "Server: $SERVER_IP"
        echo "Port: $SERVER_PORT"
        echo "Username: root"
        echo "Password: $SSH_PASSWORD"
        echo ""
        echo "🔗 Connection Command:"
        echo "ssh root@$SERVER_IP -p $SERVER_PORT"
        echo ""
        echo "⚠️  Warning: This is a temporary SSH server with root login enabled!"
        echo "=========================================="
        echo "⏰ This server will be active for 6 hours"
        echo "=========================================="

    - name: Keep server alive
      run: |
        echo "🟢 SSH server is running for 6 hours..."
        # نگه داشتن سرور فعال به مدت 6 ساعت
        sleep 21600
